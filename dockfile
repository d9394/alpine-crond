#This file is also on building and testing, Not complete.
From alpine:3.19

ARG PROXYS=http://192.168.1.1:8888

RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories && \
	apk update --allow-untrusted && \
	apk upgrade --allow-untrusted && \
	apk add --no-cache --allow-untrusted --virtual build-dependencies linux-headers \
	libressl-dev g++ make cmake gcc gfortran gcompat \
	jpeg-dev zlib-dev libjpeg-turbo-dev libpng-dev tiff-dev libwebp-dev openblas-dev libffi-dev ffmpeg-dev python3-dev && \
	apk add --no-cache --allow-untrusted \
	  python3 py-pip py3-setuptools unzip libexif udev chromium chromium-chromedriver \
	  xvfb wget  ttf-freefont sudo openssl nginx nginx-mod-stream nginx-mod-rtmp ffmpeg \
	  py3-numpy curl tesseract-ocr tesseract-ocr-data-chi_sim tesseract-ocr-data-chi_tra tesseract-ocr-data-eng tesseract-ocr-data-osd \
	  py3-opencv py3-beautifulsoup4 py3-openssl py3-pymysql \
	  py3-urllib3 py3-pyserial py3-flask py3-flask-compress py3-flask-login py3-jinja2 \
	  py3-requests py3-pysocks py3-pandas py3-rarfile py3-tz py3-pillow py3-pathlib2 && \
	rm -rf /tmp/* /var/cache/apk/* 

RUN export https_proxy=$PROXYS && \
	mkdir /noto && \
	cd /noto && \
#	wget -q "https://noto-website.storage.googleapis.com/pkgs/NotoSansCJKjp-hinted.zip" && \
	wget -q "https://src.fedoraproject.org/repo/extras/chromium/NotoSansCJKjp-hinted.zip/sha512/e7bcbc53a10b8ec3679dcade5a8a94cea7e1f60875ab38f2193b4fa8e33968e1f0abc8184a3df1e5210f6f5c731f96c727c6aa8f519423a29707d2dee5ada193/NotoSansCJKjp-hinted.zip" && \
#	wget -q https://www.hellocq.net/NotoSansCJKjp-hinted.zip && \
	unzip NotoSansCJKjp-hinted.zip && \
	mkdir -p /usr/share/fonts/noto && \
	cp *.otf /usr/share/fonts/noto && \
	chmod 644 -R /usr/share/fonts/noto/ && \
	fc-cache -fv && \
	rm -rf /noto && \
	unset https_proxy

#COPY ~/volume1/Software/Linux/songti.ttf /
COPY songti.ttf /

RUN mkdir -p /usr/share/fonts/chinese && \
	mv /songti.ttf /usr/share/fonts/chinese/ && \
	cd /usr/share/fonts/chinese && \
	fc-cache -fv

RUN echo -e "*\t*\t*\t*\t*\trun-parts /etc/periodic/minutes" >> /var/spool/cron/crontabs/root && \
	echo -e "*/5\t*\t*\t*\t*\trun-parts /etc/periodic/5min" >> /var/spool/cron/crontabs/root && \
	echo -e "*/30\t*\t*\t*\t*\trun-parts /etc/periodic/30min" >> /var/spool/cron/crontabs/root && \
	sed -i "s/\/etc\/periodic/\/Crond/g" /var/spool/cron/crontabs/root && \
	chmod -R 777 /etc/crontabs && \
	mkdir -m 666 -p /Logs && \
	sed -i "s/\# do daily\/weekly\/monthly maintenance/\# do daily\/weekly\/monthly maintenance\nSHELL=\/bin\/sh/g" /var/spool/cron/crontabs/root && \
	sed -i "s/\# %wheel ALL=(ALL) NOPASSWD: ALL/%wheel ALL=(ALL) NOPASSWD: ALL/g" /etc/sudoers && \
	adduser admin -u 1024 -D -S -s /bin/sh -G users && \
	chmod 4755 /bin/busybox && \
	echo -e "t1st-pwd\nt1st-pwd" | passwd admin && \
	echo -e "\nadmin\tALL=(ALL)\tALL\n" >> /etc/sudoers

#RUN python3 -m pip install --upgrade --index-url https://mirrors.aliyun.com/pypi/simple/ --break-system-packages pip setuptools importlib-metadata && \
RUN	python3 -m pip install --upgrade --root-user-action ignore \
  --index-url https://mirrors.aliyun.com/pypi/simple/ --break-system-packages \
  selenium pyvirtualdisplay awscli aprslib pyecharts boto3 pytesseract folium
		
#RUN export https_proxy=$PROXYS && \
#	python3 -m pip install --upgrade --proxy $PROXYS pathlib numpy Pillow pytz rarfile pandas boto3 Jinja2 requests opencv-python-headless flask Flask-Compress Flask-Login pyserial urllib3 pyOpenSSL pymysql onnxruntime ddddocr && \
#	unset https_proxy	

#RUN python3 -m pip install --upgrade --index-url https://mirrors.aliyun.com/pypi/simple/ --break-system-packages \
#	onnxruntime==1.10.0 cnocr ddddocr 
	
RUN pip cache purge && apk del build-dependencies

WORKDIR /Script

#CMD ["echo", "-e", "\"test\"", "|", "sudo", "-S", "/usr/sbin/crond","-f","-c","/var/spool/cron/crontabs","-L","/logs/cron.log","&&", "ping", "-t", "127.0.0.1"]

#RUN apk add py3-onnxruntime=1.22.1-r0 --repository=http://dl-cdn.alpinelinux.org/alpine/edge/main

COPY ./init.sh /
RUN chmod 755 /init.sh
CMD ["/init.sh"]
#CMD ["python3"]
